AI エージェント運用ルール

この文書は、CommuniCareV2 プロジェクトにおいて AI エージェントが遵守すべき共通ルールを定義する。

0. 前提

対象: Laravel 11 / Vue 3 / Inertia のマルチテナント（single DB + tenant_id）構成

目的: 安全・再現可能・レビュー容易な自動化（設計 → 実装 → テスト → 差分提示）

出力言語: 日本語

1. 実行プロセス
   入力
   <指示> {{instructions}} </指示>

手順
<タスク分析>

主要タスクを簡潔に要約する。

重要要件・制約（機密性、権限、テナント境界、既存仕様）を列挙する。

潜在的な課題とリスクを挙げる。

実行ステップを詳細化し、最適順序を決める。

必要ツール／リソース（対象ファイル、テスト、環境）を明示する。
</タスク分析>

実行

ステップを一つずつ実施し、各ステップ完了時に簡潔な進捗を記録する。

不明点や前提不足がある場合は即時報告し、代替案を提示する（独断実装は禁止）。

品質管理

生成物を即時検証する（構文、型、既存テストとの整合）。

エラーや不整合を検知したら直ちに修正。

コマンド実行時は標準出力を確認し、結果を要約する。

最終確認

当初指示との整合をチェックし、必要に応じて微調整。

変更差分（diff）を提示し、テスト結果を添付する。

結果報告（固定フォーマット）

# 実行結果報告

## 概要

…（全体要約）

## 実行ステップ

1. …（ステップと結果）
2. …

## 最終成果物

-   変更ファイル一覧
-   主要 diff（抜粋）
-   関連テスト結果（抜粋）

## 注意点・改善提案

-   …

2. セーフティ・制約
   絶対禁止（生成・提案ともに不可）

破壊的コマンド: migrate:fresh, migrate:reset, migrate:rollback, db:wipe

危険操作: truncate, DROP TABLE, ALTER TABLE ... DROP COLUMN

テストトレイト: RefreshDatabase

全テナント読み取り: Model::all(), Model::query()->get()（tenant_id フィルタなし）

常時必須

すべての取得・更新・削除で tenant_id を必須とする。

権限制御（Spatie Permission）とポリシーを考慮する。

プロジェクトの仕様ドキュメントと矛盾する生成は行わない。

テストは SQLite(:memory:) 前提、TestCase 継承、セーフティネット有効。

緊急停止条件（検知したら即中断し報告）

破壊的マイグレーション／危険操作の混入

tenant_id 欠落もしくは越境アクセス

仕様ドキュメントに未定義の勝手な拡張・スキーマ変更

RefreshDatabase の使用提案

3. 出力・差分提示ルール

変更は最小差分で、意味的整合性を担保する。

大規模変更が不可避な場合、理由・影響範囲・後方互換性を明記する。

生成後は必ず diff を提示し、関連テストの要旨を添える。

4. Git 運用
   許可された自動操作（要確認不要）

対象ブランチ: feature/_, fix/_, chore/_, docs/_

操作: git add, diff 提示, PR 作成（ドラフト推奨）

コミット実行前の確認

git commit および git push を実行する前に、必ずユーザーに確認を求める。

変更を完了したら、コミットメッセージを提案し、ユーザーの承認を得てから実行する。

禁止（明示許可がない限り不可）

main, master, develop, release/\* への push/rebase

ユーザー確認なしでの git commit/git push の実行

マージ時の PR 作成必須

main, master, develop, release/\* へのマージを行う場合は、必ず事前に Pull Request を作成し、レビューを経てからマージする。

直接マージ（`git merge` を main/master に直接実行）は禁止。

マージ前の確認事項:

-   PR が作成されているか
-   PR のレビューが完了しているか（必要に応じて）
-   CI/CD チェックが通過しているか

例外: 緊急のホットフィックスなど、明示的な許可がある場合のみ直接マージを許可する。

5. Git commit 指針

コミット実行前の確認

変更を完了したら、適切なタイミングでユーザーに以下を確認する：

「以下の変更点をコミットしてもよろしいですか？コミットメッセージを提案します。」

ユーザーの承認を得てからコミットを実行する。承認がない場合はコミットしない。

コミットメッセージテンプレート

以下の変更点を確認したうえで、条件を満たすようにして、コミットメッセージを日本語で提案してください。

## 変更点

（変更内容の要約を記載）

## 理由

（変更理由を記載）

## 1 行目

コミット種別と要約を書きます。フォーマットは以下とします。

_[コミット種別]要約_

### コミット種別

以下の中から適切な種別を選びます。

-   fix：バグ修正
-   add：新規（ファイル）機能追加
-   update：機能修正（バグではない）
-   remove：削除（ファイル）

### 要約

変更内容の概要を書きます。シンプルかつ分かりやすく 1 行ぐらいで。

【例】削除フラグが更新されない不具合の修正

## 2 行目

空白

## 3 行目

変更した理由を出来るかぎり具体的に、かつ簡潔に書きます。

【例】refs #110 更新 SQL の対象カラムに削除フラグが含まれていなかったため追加しました。

従来のフォーマット（参考）

基本フォーマット

git commit -m "{{タイプ}}: {{タイトル}}" -m "{{本文}}"

タイプ

feat: 新機能

fix: バグ修正

docs: ドキュメント変更

style: コードスタイル

refactor: リファクタ

perf: 性能改善

test: テスト

chore: ビルド・ツール

メッセージ規範

日本語で簡潔に要約し、目的・主要変更点を明確化。

ファイル履歴は含めない。必要なら箇条書き可。

差分管理

変更は慎重に分割。必要なら複数ブランチ化。

変更履歴が利用可能な場合: 変更履歴ベースで要約。

変更履歴が利用できない場合: main ブランチとの差分を要約。

## コミット粒度の方針

**重要**: コミットの粒度を以前よりも上げることを推奨します。以下の原則に従って、より細かく、より頻繁にコミットしてください。

### コミット粒度の原則

1. **1 つのコミット = 1 つの論理的な変更**

    - 複数の機能や修正を 1 つのコミットにまとめない
    - 関連する変更でも、明確に分離できる場合は別々のコミットにする

2. **小さな変更でも積極的にコミット**

    - ファイル 1 つの変更でも、意味のある変更であればコミットする
    - 「まだ完成していない」という理由でコミットを遅らせない

3. **機能追加とバグ修正は分離**

    - 新機能の追加とバグ修正が混在している場合は、別々のコミットにする

4. **リファクタリングは独立したコミット**

    - 機能追加やバグ修正と同時に行ったリファクタリングは、別のコミットにする

5. **テスト追加も独立したコミット**
    - テストコードの追加は、実装コードとは別のコミットにすることを検討

### コミット頻度の目安

-   **作業単位ごとにコミット**: 1 つの機能や修正が完了したら即座にコミット
-   **複数ファイルの変更**: 関連性が低い場合は別々のコミットを検討
-   **段階的な実装**: 大きな機能でも、段階的にコミットしながら進める

### コミットメッセージの粒度

-   コミットメッセージは、そのコミットで行った変更のみを記述
-   将来の予定や未実装の機能は含めない
-   変更の理由と影響範囲を明確に記述

6. Pull Request 指針

作成前の事前チェック（必須）

PR を作成する前に、以下のコマンドで最低限の事前チェックをローカルで行う:

```bash
# リモートとの差分を取得
git fetch

# main との差分コミットを確認
git log origin/main..HEAD --oneline

# 差分ファイル・行数を確認
git diff origin/main..HEAD --stat

# クリティカルな修正（仕様に直結する部分）が差分に含まれているかピンポイントで確認
git diff origin/main..HEAD
```

**注意**: これらの事前チェック結果（差分コミット、差分ファイル・行数、クリティカルな修正）は PR 本文には含めない。事前チェックは PR 作成前の確認作業としてのみ実行し、PR 本文には記載しない。

PR テンプレート

以下のテンプレートに従って PR を作成する:

**注意**: タイトルは `--title` オプションで指定し、PR 本文には含めない。

### 目的

この変更を行った背景と目標

### 達成条件

完了とみなすための条件・基準

### 実装の概要

主な変更点と実装内容の説明

### 対処したバグ

修正したバグや問題（該当する場合）

### 必要なかった実装

採用を検討したが結果的に削除・見送った内容

変更・追加した内容について、最終的に削除したものは「〇〇の理由で採用を検討したが、〇〇の理由により結果的に削除した（採用を見送った）」のように記述する。

### レビューしてほしいところ

特に確認してもらいたい箇所や観点

### 不安に思っていること

懸念点や疑問に感じている部分

### 保留していること

今回は対応せず、今後検討する項目

作成コマンド（ドラフト）

gh pr create \
 --draft \
 --title "{{PRタイトル}}" \
 --body "$(cat << 'EOF'

### 目的

{{目的}}

### 達成条件

{{達成条件}}

### 実装の概要

{{実装の概要}}

### 対処したバグ

{{対処したバグ（該当する場合）}}

### 必要なかった実装

{{採用を検討したが結果的に削除・見送った内容}}

### レビューしてほしいところ

{{特に確認してもらいたい箇所や観点}}

### 不安に思っていること

{{懸念点や疑問に感じている部分}}

### 保留していること

{{今回は対応せず、今後検討する項目}}

EOF
)"

作成ポリシー

ドラフト PR として作成、対象は main。

事前チェックを必ず実行するが、その結果は PR 本文には含めない（事前チェックは PR 作成前の確認作業としてのみ実行）。

セクションは省略せず記入（目的/実装の概要/レビューしてほしいところは必須）。

タイトルは `--title` オプションで指定し、PR 本文には含めない。

7. 不明点・判断事項の扱い

不明点がある場合、作業開始前に明確化する。

重要判断は逐次報告し、承認を得る。

予期せぬ問題が生じた場合、即時報告し代替案を提示する。

独断の仕様追加・既存仕様の逸脱は禁止。

8. Done クリテリア（各タスク共通）

プロジェクトの仕様ドキュメントとの整合が取れている。

安全制約（テナント境界・権限・禁止操作）を満たす。

テストが通る（新規・影響範囲の回帰を含む）。

変更差分が最小で、レビュー観点が記述されている。

コミット／PR が規範に従っている。

9. 参考（推奨プロンプト雛形）
   以下の指示を実行してください。

<指示>
{{instructions}}
</指示>

制約:

-   本ファイル rules_for_ai.md の全ルールを厳守
-   プロジェクトの仕様ドキュメントを"正"として参照
-   設計 → 実装 → テスト →diff 提示の順
-   不明点は実装せず質問で返す

出力:

-   # 実行結果報告（固定フォーマット）
-   主要 diff（抜粋）
-   テスト結果要約

10. トラブルシューティングドキュメント作成ガイドライン

トラブルシューティングドキュメントは、問題解決後に作成することで、チーム全体で知識を共有し、再発を防ぐために重要です。

作成判断基準

以下の条件を満たす場合、トラブルシューティングドキュメントを作成することを推奨します：

-   解決に15分以上かかった問題
-   複数のステップが必要な解決手順
-   再発する可能性が高い問題（環境固有の問題、設定ミスなど）
-   チーム全体で共有すべき情報

作成不要なケース

-   簡単なタイポ修正など、即座に解決できる問題
-   一度限りの問題で、再発する可能性が低い
-   個人の環境固有の問題で、他の開発者には影響しない

ドキュメント配置場所

トラブルシューティングドキュメントは `docs/troubleshooting/` ディレクトリに配置します。

ファイル命名規則: `{エラーコードまたは問題名}-{簡潔な説明}.md`

例:
-   `docs/troubleshooting/503-service-unavailable.md`
-   `docs/troubleshooting/docker-container-connection-error.md`
-   `docs/troubleshooting/database-migration-failure.md`

ドキュメントテンプレート

以下のテンプレートに従って作成します：

```markdown
# {エラー名または問題名} 解決手順

## 問題の原因

{問題の原因を簡潔に説明}

## 解決手順

### 1. {最初のステップ}

{手順の説明}

```bash
{実行コマンド}
```

**期待される結果**: {期待される結果}

### 2. {次のステップ}

{手順の説明}

## 追加のトラブルシューティング

{追加の対処法があれば記載}

## 確認コマンド一覧

```bash
# 確認用コマンドを列挙
```

## 参考情報

-   {関連ドキュメントへのリンク}
```

作成後の運用

-   ドキュメント作成後は、即座に master/main ブランチにマージすることを推奨します
-   ローカルだけに残すのではなく、チーム全体で共有できるようにします
-   ブランチ名は `docs/troubleshooting-{問題名}` または `docs/add-troubleshooting-{問題名}` を使用します

11. 改訂

本ルールは運用結果に基づき継続的に改善する。

重大事故や逸脱が発生した場合は優先して改訂する。
