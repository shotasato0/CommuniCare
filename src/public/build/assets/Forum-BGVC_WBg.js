import{o as s,f as a,p as Be,e as X,g as y,b as t,d as Y,t as $,i as ae,H as Re,F as z,k as te,n as J,I as Ke,h as Te,D as de,J as He,u as I,r as v,s as re,K as Se,q as ne,a as F,c as j,w as ee,W as P,L as We,E as $e,P as Ye,l as ue,M as Je,m as Qe,N as Ge}from"./app-BGfmsnWH.js";import{A as Ze,_ as Xe}from"./AuthenticatedLayout-CUiVAEbY.js";import{g as Me,d as et}from"./deleteItem-B-EMaGVh.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{h as Ee}from"./imageHandler-DFZSy6p1.js";import tt from"./Show-ZuKv-erW.js";import lt from"./ListForSidebar-CK1BuLeA.js";import rt from"./RightSidebar-CYZ08EMz.js";import{d as st}from"./dayjs.min-BfedqCIq.js";import"./ApplicationLogo-BvExYBVO.js";import"./Footer-C77glWd_.js";const se={__name:"ImageModal",props:{isOpen:Boolean},emits:["close"],setup(e,{emit:r}){const l=r,m=()=>{l("close")};return(n,d)=>e.isOpen?(s(),a("div",{key:0,class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",onClick:X(m,["self"])},[Be(n.$slots,"default")])):y("",!0)}},ot={name:"FileUpload",emits:["files-changed","error"],props:{visible:{type:Boolean,default:!0},maxFiles:{type:Number,default:10}},data(){return{files:[],hasError:!1,errorMessage:"",acceptedTypes:".jpg,.jpeg,.png,.gif,.webp,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv",maxFileSize:10*1024*1024,supportedMimeTypes:["image/jpeg","image/png","image/gif","image/webp","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","text/csv"],previewUrlKey:"_previewUrl"}},methods:{processExternalFiles(e){if(!e||e.length===0)return;const r=Array.from(e);this.processFiles(r)},openFileDialog(){this.$refs.fileInput&&this.$refs.fileInput.click()},handleFileSelect(e){const r=Array.from(e.target.files);this.processFiles(r)},processFiles(e){this.clearError();const r=[],l=this.maxFiles-this.files.length;e.length>l&&this.showError(`一度に添付できるファイルは最大${this.maxFiles}個までです`);const m=e.slice(0,Math.max(0,l));for(const n of m)this.validateFile(n)&&r.push(n);r.length>0&&(this.files=[...this.files,...r],this.$emit("files-changed",this.files))},validateFile(e){return e.size>this.maxFileSize?(this.showError(`${e.name} はファイルサイズが大きすぎます（最大10MB）`),!1):this.supportedMimeTypes.includes(e.type)?this.files.some(r=>r.name===e.name&&r.size===e.size)?(this.showError(`${e.name} は既に追加されています`),!1):!0:(this.showError(`${e.name} はサポートされていないファイル形式です`),!1)},removeFile(e){const r=this.files[e];r&&this.isImage(r)&&r[this.previewUrlKey]&&(URL.revokeObjectURL(r[this.previewUrlKey]),delete r[this.previewUrlKey]),this.files.splice(e,1),this.$emit("files-changed",this.files)},getFileIcon(e){const r=e.type.toLowerCase();return r.startsWith("image/")?"bi bi-file-earmark-image-fill text-blue-600":r==="application/pdf"?"bi bi-file-earmark-pdf-fill text-red-600":r.includes("word")||r.includes("document")?"bi bi-file-earmark-word-fill text-blue-800":r.includes("sheet")||r.includes("excel")?"bi bi-file-earmark-excel-fill text-green-600":r.startsWith("text/")?"bi bi-file-earmark-text-fill text-gray-600":"bi bi-file-earmark-fill text-gray-500"},isImage(e){return e.type.startsWith("image/")},getPreviewUrl(e){return this.isImage(e)?(e[this.previewUrlKey]||(e[this.previewUrlKey]=URL.createObjectURL(e)),e[this.previewUrlKey]):null},formatFileSize(e){if(e===0)return"0 Bytes";const r=1024,l=["Bytes","KB","MB","GB"],m=Math.floor(Math.log(e)/Math.log(r));return parseFloat((e/Math.pow(r,m)).toFixed(2))+" "+l[m]},showError(e){this.hasError=!0,this.errorMessage=e,this.$emit("error",e),setTimeout(()=>{this.clearError()},3e3)},clearError(){this.hasError=!1,this.errorMessage=""},reset(){this.files=[],this.clearError(),this.$refs.fileInput.value=""},getFiles(){return this.files}},beforeUnmount(){this.files.forEach(e=>{this.isImage(e)&&e[this.previewUrlKey]&&(URL.revokeObjectURL(e[this.previewUrlKey]),delete e[this.previewUrlKey])})}},at={class:"file-upload-container"},it=["accept"],nt={key:0,class:"error-message"},dt={key:1,class:"uploaded-files"},ut={class:"uploaded-files-title"},ct={class:"file-list"},mt={class:"file-icon"},gt={class:"file-info"},vt={class:"file-name"},ft={class:"file-size"},pt={key:0,class:"file-preview"},bt=["src","alt"],ht=["onClick","title"];function yt(e,r,l,m,n,d){return s(),a("div",at,[t("input",{ref:"fileInput",type:"file",multiple:"",accept:n.acceptedTypes,onChange:r[0]||(r[0]=(...c)=>d.handleFileSelect&&d.handleFileSelect(...c)),class:"hidden-file-input"},null,40,it),n.hasError?(s(),a("div",nt,[r[1]||(r[1]=t("i",{class:"bi bi-exclamation-triangle-fill"},null,-1)),Y(" "+$(n.errorMessage),1)])):y("",!0),n.files.length>0?ae((s(),a("div",dt,[t("h4",ut,[r[2]||(r[2]=t("i",{class:"bi bi-files"},null,-1)),Y(" 添付ファイル ("+$(n.files.length)+") ",1)]),t("div",ct,[(s(!0),a(z,null,te(n.files,(c,i)=>(s(),a("div",{key:`file-${i}`,class:"file-item"},[t("div",mt,[t("i",{class:J(d.getFileIcon(c))},null,2)]),t("div",gt,[t("span",vt,$(c.name),1),t("span",ft,$(d.formatFileSize(c.size)),1)]),d.isImage(c)?(s(),a("div",pt,[t("img",{src:d.getPreviewUrl(c),alt:c.name},null,8,bt)])):y("",!0),t("button",{type:"button",onClick:g=>d.removeFile(i),class:"remove-file-button",title:`${c.name}を削除`},r[3]||(r[3]=[t("i",{class:"bi bi-x-circle-fill"},null,-1)]),8,ht)]))),128))])],512)),[[Re,l.visible]]):y("",!0)])}const me=ce(ot,[["render",yt],["__scopeId","data-v-80ac8f6f"]]),kt={class:"relative"},xt=["rows","placeholder"],_t=["title","aria-label"],ge=Object.assign({inheritAttrs:!1},{__name:"TextareaWithAttach",props:{modelValue:{type:String,default:""},placeholder:{type:String,default:""},rows:{type:Number,default:3},textareaClass:{type:String,default:"w-full p-2 pr-12 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"},rightOffsetClass:{type:String,default:"right-3"},bottomOffsetClass:{type:String,default:"bottom-5"},buttonTitle:{type:String,default:"ファイルを選択"},buttonAriaLabel:{type:String,default:"ファイルを選択"},dragActive:{type:Boolean,default:!1}},emits:["update:modelValue","attach-click"],setup(e,{emit:r}){const l=e,m=r,n=Ke(),d=Te({get:()=>l.modelValue,set:c=>m("update:modelValue",c)});return(c,i)=>(s(),a("div",kt,[ae(t("textarea",He({"onUpdate:modelValue":i[0]||(i[0]=g=>d.value=g),rows:e.rows,placeholder:e.placeholder,class:e.textareaClass},I(n)),null,16,xt),[[de,d.value]]),t("button",{type:"button",class:J(["absolute bg-gray-300 dark:bg-gray-600 text-black dark:text-gray-300 transition hover:bg-gray-400 dark:hover:bg-gray-500 rounded-md flex items-center justify-center cursor-pointer p-2",[e.rightOffsetClass,e.bottomOffsetClass,{"pointer-events-none":e.dragActive}]]),style:{width:"40px",height:"40px"},title:e.buttonTitle,"aria-label":e.buttonAriaLabel,onClick:i[1]||(i[1]=g=>c.$emit("attach-click"))},i[2]||(i[2]=[t("i",{class:"bi bi-paperclip text-2xl"},null,-1)]),10,_t)]))}}),wt={class:"absolute inset-0 z-20 flex items-center justify-center pointer-events-none"},Le={__name:"DropOverlay",setup(e){return(r,l)=>(s(),a("div",wt,l[0]||(l[0]=[t("div",{class:"w-full h-full border-2 border-dashed border-blue-400 bg-blue-50/70 dark:bg-blue-900/30 rounded-md flex items-center justify-center"},[t("div",{class:"text-center text-blue-700 dark:text-blue-200"},[t("i",{class:"bi bi-paperclip text-3xl mb-2 block"}),t("p",null,"ここにファイルをドロップして添付")])],-1)])))}};function Ne(e){const r=v(!1);let l=0,m,n=null;const d=()=>{n&&(clearTimeout(n),n=null),r.value=!0},c=(x=100)=>{n&&clearTimeout(n),n=setTimeout(()=>{r.value=!1,n=null},x)},i=x=>{var C;const S=(C=x==null?void 0:x.dataTransfer)==null?void 0:C.types;return S&&S.includes&&S.includes("Files")},g=x=>{i(x)&&(x.preventDefault(),l++,d())},h=x=>{i(x)&&(x.preventDefault(),d())},o=x=>{i(x)&&(x.preventDefault(),l=Math.max(0,l-1),l===0&&c(120))},k=x=>{var C;if(!i(x))return;x.preventDefault(),l=0,n&&(clearTimeout(n),n=null),r.value=!1;const S=((C=x.dataTransfer)==null?void 0:C.files)||[];S&&S.length>0&&typeof e=="function"&&e(S)},_=()=>{l=0,r.value=!1};return re(()=>{m=x=>{i(x)&&x.preventDefault()},window.addEventListener("dragover",m),window.addEventListener("drop",m)}),Se(()=>{m&&(window.removeEventListener("dragover",m),window.removeEventListener("drop",m))}),{isDragOver:r,onTextDragEnter:g,onTextDragOver:h,onTextDragLeave:o,onTextDrop:k,onTextMouseLeave:_}}const Ct={class:"bg-white dark:bg-gray-800 rounded-md mt-5 p-3"},$t={class:"flex mt-2"},It={class:"flex flex-col mt-2"},Ft={class:"relative"},Dt={class:"mt-4"},Ut={key:0,class:"text-red-500 dark:text-red-400 mt-2"},Tt={key:1,class:"legacy-upload"},St={key:0,class:"relative mt-2 inline-block"},Mt=["src"],Et=["src"],Lt={__name:"PostForm",props:{forumId:[String,Number]},setup(e){const r=e,l=v({title:"",message:"",forum_id:r.forumId?Number(r.forumId):null}),m=v(null),n=v(null),d=v(null),c=v(!1),i=v(null),g=v(null),h=v([]),o=v(!0),{isDragOver:k,onTextDragEnter:_,onTextDragOver:x,onTextDragLeave:S,onTextDrop:C,onTextMouseLeave:L}=Ne(u=>{g.value&&g.value.processExternalFiles(u)});ne(()=>r.forumId,u=>{l.value.forum_id=u?Number(u):null});const O=u=>{Ee(u,m,n,i)},Q=()=>{d.value.click()},B=()=>{m.value=null,n.value=null,d.value&&(d.value.value="")},q=u=>{console.log("=== handleFilesChanged ==="),console.log("受信ファイル数:",u.length),console.log("ファイル詳細:",u),h.value=u},G=u=>{i.value=u},V=()=>{if(!l.value.forum_id||l.value.forum_id===0){console.error("有効な掲示板IDが選択されていません。");return}console.log("=== PostForm Debug ==="),console.log("useUnifiedUpload:",o.value),console.log("attachedFiles.length:",h.value.length),console.log("attachedFiles:",h.value),console.log("image:",m.value);const u=new FormData;u.append("title",l.value.title),u.append("message",l.value.message),u.append("forum_id",l.value.forum_id),u.append("_token",Me()),o.value&&h.value.length>0?(console.log("統一システムでファイル送信:",h.value.length,"files"),h.value.forEach((f,D)=>{u.append(`files[${D}]`,f),console.log(`files[${D}]:`,f.name,f.size)})):m.value?(console.log("レガシーシステムでファイル送信:",m.value.name),u.append("image",m.value)):console.log("ファイルが選択されていません"),P.post(route("forum.store"),u,{onSuccess:()=>{R(),P.get(route("forum.index",{forum_id:l.value.forum_id}),{preserveState:!0})},onError:f=>{console.error("投稿に失敗しました:",f),i.value="投稿に失敗しました。もう一度お試しください。"}})},R=()=>{l.value={title:"",message:"",forum_id:r.forumId},g.value&&g.value.reset(),h.value=[],m.value=null,n.value=null,d.value&&(d.value.value=""),i.value=null};return(u,f)=>(s(),a("div",Ct,[t("form",{onSubmit:X(V,["prevent"]),enctype:"multipart/form-data"},[t("div",$t,[f[5]||(f[5]=t("p",{class:"font-medium text-gray-900 dark:text-gray-100"},"件名",-1)),ae(t("input",{"onUpdate:modelValue":f[0]||(f[0]=D=>l.value.title=D),class:"border-gray-300 dark:border-gray-600 rounded-md px-2 ml-2 flex-auto bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",type:"text",required:"",placeholder:"件名を入力してください"},null,512),[[de,l.value.title]])]),t("div",It,[f[6]||(f[6]=t("p",{class:"font-medium text-gray-900 dark:text-gray-100"},"本文",-1)),t("div",Ft,[F(ge,{modelValue:l.value.message,"onUpdate:modelValue":f[1]||(f[1]=D=>l.value.message=D),rows:3,placeholder:"本文を入力してください","textarea-class":"w-full p-2 pr-12 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100","button-title":"ファイルを選択","button-aria-label":"ファイルを選択","drag-active":I(k),onAttachClick:f[2]||(f[2]=D=>{var M;return(M=g.value)==null?void 0:M.openFileDialog()}),onDragenter:I(_),onDragover:I(x),onDragleave:I(S),onDrop:I(C),onMouseleave:I(L)},null,8,["modelValue","drag-active","onDragenter","onDragover","onDragleave","onDrop","onMouseleave"]),I(k)?(s(),j(Le,{key:0})):y("",!0)])]),t("div",Dt,[F(me,{ref_key:"fileUploadRef",ref:g,visible:I(k)||h.value&&h.value.length>0,onFilesChanged:q,onError:G},null,8,["visible"])]),i.value?(s(),a("div",Ut,$(i.value),1)):y("",!0),o.value?y("",!0):(s(),a("div",Tt,[f[9]||(f[9]=t("p",{class:"font-medium text-gray-900 dark:text-gray-100 mb-2"},"画像添付",-1)),t("button",{type:"button",onClick:Q,class:"px-4 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"},f[7]||(f[7]=[t("i",{class:"bi bi-image mr-2"},null,-1),Y(" 画像を選択 ")])),t("input",{type:"file",accept:"image/*",ref_key:"fileInput",ref:d,onChange:O,style:{display:"none"}},null,544),n.value?(s(),a("div",St,[t("img",{src:n.value,alt:"画像プレビュー",class:"w-32 h-32 object-cover rounded-md cursor-pointer hover:opacity-80 transition",onClick:f[3]||(f[3]=D=>c.value=!0)},null,8,Mt),t("div",{class:"absolute top-0 right-0 bg-white dark:bg-gray-800 rounded-full p-1 cursor-pointer flex items-center justify-center",onClick:B,title:"画像を削除",style:{width:"24px",height:"24px"}},f[8]||(f[8]=[t("i",{class:"bi bi-x-circle text-black dark:text-gray-300 hover:text-gray-500 dark:hover:text-gray-400"},null,-1)]))])):y("",!0),F(se,{isOpen:c.value,onClose:f[4]||(f[4]=D=>c.value=!1)},{default:ee(()=>[t("img",{src:n.value,class:"max-w-full max-h-full rounded-lg"},null,8,Et)]),_:1},8,["isOpen"])])),f[10]||(f[10]=t("div",{class:"flex justify-end mt-2"},[t("button",{class:"my-2 px-4 py-2 rounded-md bg-blue-100 dark:bg-blue-800 text-blue-700 dark:text-blue-300 transition hover:bg-blue-300 dark:hover:bg-blue-600 hover:text-white cursor-pointer"},[t("i",{class:"bi bi-send"})])],-1))],32)]))}},Nt={class:"mt-4"},Pt={class:"relative"},Vt={class:"mt-3"},At={key:0,class:"text-red-500 dark:text-red-400 mt-2"},Ot={key:1,class:"legacy-upload",style:{display:"none"}},qt={key:0,class:"relative mt-2 inline-block"},jt=["src"],zt=["src"],ve={__name:"CommentForm",props:{postId:{type:Number,required:!0},parentId:{type:Number,default:null},selectedForumId:{type:Number,required:!0},replyToName:{type:String,default:""},title:{type:String,default:"返信"}},emits:["cancel"],setup(e,{emit:r}){const l=e,m=r,n=v(`@${l.replyToName} さんへの返信を入力`),d=v({post_id:l.postId,parent_id:l.parentId,message:"",replyToName:l.replyToName}),c=v(null),i=v(null),g=v(null),h=v(!1),o=v(null),k=v(null),_=v([]),x=v(!0),{isDragOver:S,onTextDragEnter:C,onTextDragOver:L,onTextDragLeave:O,onTextDrop:Q,onTextMouseLeave:B}=Ne(M=>{k.value&&k.value.processExternalFiles(M)});re(()=>{l.replyToName&&l.parentId&&(d.value.message=`@${l.replyToName} `)});const q=M=>{Ee(M,c,i,o)},G=()=>{c.value=null,i.value=null,g.value&&(g.value.value="")},V=M=>{_.value=M},R=M=>{o.value=M},u=()=>{const M=Me(),U=new FormData;U.append("message",d.value.message),U.append("post_id",l.postId),U.append("_token",M),l.parentId&&U.append("parent_id",l.parentId),x.value&&_.value.length>0?_.value.forEach((E,Z)=>{U.append(`files[${Z}]`,E)}):c.value&&U.append("image",c.value),P.post(route("comment.store",{post:l.postId}),U,{preserveScroll:!0,onSuccess:()=>{f(),P.visit(route("forum.index",{forum_id:l.selectedForumId}),{preserveScroll:!0,replace:!0})},onError:E=>{console.error("コメントの投稿に失敗しました:",E),o.value="コメントの投稿に失敗しました。もう一度お試しください。"}})},f=()=>{d.value={post_id:l.postId,parent_id:l.parentId,message:l.replyToName&&l.parentId?`@${l.replyToName} `:"",replyToName:l.replyToName},k.value&&k.value.reset(),_.value=[],c.value=null,i.value=null,g.value&&(g.value.value=""),o.value=null},D=()=>{d.value={post_id:l.postId,parent_id:l.parentId,message:"",replyToName:l.replyToName},m("cancel")};return(M,U)=>(s(),a("div",Nt,[t("form",{onSubmit:X(u,["prevent"]),enctype:"multipart/form-data"},[t("div",null,[t("div",Pt,[F(ge,{modelValue:d.value.message,"onUpdate:modelValue":U[0]||(U[0]=E=>d.value.message=E),rows:3,placeholder:n.value,"drag-active":I(S),onAttachClick:U[1]||(U[1]=E=>{var Z;return(Z=k.value)==null?void 0:Z.openFileDialog()}),onDragenter:I(C),onDragover:I(L),onDragleave:I(O),onDrop:I(Q),onMouseleave:I(B)},null,8,["modelValue","placeholder","drag-active","onDragenter","onDragover","onDragleave","onDrop","onMouseleave"]),I(S)?(s(),j(Le,{key:0})):y("",!0)])]),t("div",Vt,[F(me,{ref_key:"fileUploadRef",ref:k,visible:I(S)||_.value&&_.value.length>0,onFilesChanged:V,onError:R},null,8,["visible"])]),o.value?(s(),a("div",At,$(o.value),1)):y("",!0),x.value?y("",!0):(s(),a("div",Ot,[t("input",{type:"file",accept:"image/*",ref_key:"fileInput",ref:g,onChange:q,style:{display:"none"}},null,544),i.value?(s(),a("div",qt,[t("img",{src:i.value,alt:"画像プレビュー",class:"w-32 h-32 object-cover rounded-md cursor-pointer hover:opacity-80 transition",onClick:U[2]||(U[2]=E=>h.value=!0)},null,8,jt),t("div",{class:"absolute top-0 right-0 bg-white dark:bg-gray-800 rounded-full p-1 cursor-pointer flex items-center justify-center",onClick:G,title:"画像を削除",style:{width:"24px",height:"24px"}},U[4]||(U[4]=[t("i",{class:"bi bi-x-circle text-black dark:text-gray-300 hover:text-gray-500 dark:hover:text-gray-400"},null,-1)]))])):y("",!0),F(se,{isOpen:h.value,onClose:U[3]||(U[3]=E=>h.value=!1)},{default:ee(()=>[t("img",{src:i.value,class:"max-w-full max-h-full rounded-lg"},null,8,zt)]),_:1},8,["isOpen"])])),t("div",{class:"flex justify-end space-x-2 mt-2"},[t("button",{type:"button",onClick:D,class:"my-2 py-2 px-4 rounded-md bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium transition hover:bg-gray-500 dark:hover:bg-gray-500 hover:text-white focus:outline-none focus:shadow-outline"},U[5]||(U[5]=[t("i",{class:"bi bi-x-lg"},null,-1)])),U[6]||(U[6]=t("button",{type:"submit",class:"my-2 px-4 py-2 rounded-md bg-blue-100 dark:bg-blue-800 text-blue-700 dark:text-blue-300 transition hover:bg-blue-300 dark:hover:bg-blue-600 hover:text-white cursor-pointer"},[t("i",{class:"bi bi-send"})],-1))])],32)]))}},Bt={name:"AttachmentList",props:{attachments:{type:Array,default:()=>[]},showTitle:{type:Boolean,default:!0},canDelete:{type:Boolean,default:!1}},emits:["delete-attachment"],data(){return{selectedImage:null}},methods:{getFileIcon(e){return{image:"bi bi-file-earmark-image-fill text-blue-600",pdf:"bi bi-file-earmark-pdf-fill text-red-600",document:"bi bi-file-earmark-word-fill text-blue-800",excel:"bi bi-file-earmark-excel-fill text-green-600",text:"bi bi-file-earmark-text-fill text-gray-600"}[e]||"bi bi-file-earmark-fill text-gray-500"},getFileTypeLabel(e){return{image:"画像",pdf:"PDF",document:"Word文書",excel:"Excel",text:"テキスト"}[e]||"ファイル"},formatFileSize(e){if(!e||isNaN(e)||e===0)return"0 Bytes";const r=1024,l=["Bytes","KB","MB","GB"],m=Math.floor(Math.log(e)/Math.log(r)),n=Math.min(m,l.length-1);return parseFloat((e/Math.pow(r,n)).toFixed(2))+" "+l[n]},openImageModal(e){this.selectedImage=e},closeImageModal(){this.selectedImage=null},downloadFile(e){window.open(e.url,"_blank")},deleteAttachment(e){confirm(`"${e.original_name}" を削除しますか？`)&&this.$emit("delete-attachment",e)}}},Rt={key:0,class:"attachment-list"},Kt={key:0,class:"attachment-title"},Ht={class:"attachment-grid"},Wt=["onClick"],Yt=["src","alt"],Jt=["onClick"],Qt={class:"file-icon-large"},Gt={class:"file-info"},Zt={class:"file-name"},Xt={class:"file-size"},el={class:"file-type"},tl=["onClick","title"],ll={class:"image-modal-header"},rl={class:"image-modal-title"},sl={class:"image-modal-body"},ol=["src","alt"],al={class:"image-modal-footer"},il={class:"image-info"};function nl(e,r,l,m,n,d){return l.attachments&&l.attachments.length>0?(s(),a("div",Rt,[l.showTitle?(s(),a("h4",Kt,[r[4]||(r[4]=t("i",{class:"bi bi-paperclip"},null,-1)),Y(" 添付ファイル ("+$(l.attachments.length)+") ",1)])):y("",!0),t("div",Ht,[(s(!0),a(z,null,te(l.attachments,c=>(s(),a("div",{key:c.id,class:J(["attachment-item group",{"attachment-image":c.file_type==="image"}])},[c.file_type==="image"?(s(),a("div",{key:0,class:"attachment-image-preview",onClick:i=>d.openImageModal(c)},[t("img",{src:c.url,alt:c.original_name,loading:"lazy"},null,8,Yt),r[5]||(r[5]=t("div",{class:"image-overlay"},[t("i",{class:"bi bi-zoom-in"})],-1))],8,Wt)):(s(),a("div",{key:1,class:"attachment-file",onClick:i=>d.downloadFile(c)},[t("div",Qt,[t("i",{class:J(d.getFileIcon(c.file_type))},null,2)]),t("div",Gt,[t("span",Zt,$(c.original_name),1),t("span",Xt,$(d.formatFileSize(c.file_size)),1),t("span",el,$(d.getFileTypeLabel(c.file_type)),1)]),r[6]||(r[6]=t("div",{class:"download-icon"},[t("i",{class:"bi bi-download"})],-1))],8,Jt)),l.canDelete?(s(),a("button",{key:2,onClick:i=>d.deleteAttachment(c),class:"delete-attachment-button",title:`${c.original_name}を削除`},r[7]||(r[7]=[t("i",{class:"bi bi-x-circle-fill"},null,-1)]),8,tl)):y("",!0)],2))),128))]),n.selectedImage?(s(),a("div",{key:1,class:"image-modal-overlay",onClick:r[3]||(r[3]=(...c)=>d.closeImageModal&&d.closeImageModal(...c))},[t("div",{class:"image-modal",onClick:r[2]||(r[2]=X(()=>{},["stop"]))},[t("div",ll,[t("h3",rl,$(n.selectedImage.original_name),1),t("button",{onClick:r[0]||(r[0]=(...c)=>d.closeImageModal&&d.closeImageModal(...c)),class:"image-modal-close"},r[8]||(r[8]=[t("i",{class:"bi bi-x-lg"},null,-1)]))]),t("div",sl,[t("img",{src:n.selectedImage.url,alt:n.selectedImage.original_name,class:"modal-image"},null,8,ol)]),t("div",al,[t("span",il,$(d.formatFileSize(n.selectedImage.file_size)),1),t("button",{onClick:r[1]||(r[1]=c=>d.downloadFile(n.selectedImage)),class:"download-button"},r[9]||(r[9]=[t("i",{class:"bi bi-download"},null,-1),Y(" ダウンロード ")]))])])])):y("",!0)])):y("",!0)}const oe=ce(Bt,[["render",nl],["__scopeId","data-v-85b4bca5"]]),dl={key:0},ul={class:"ml-4 mb-2 pl-2"},cl={class:"text-xs text-gray-500 dark:text-gray-400"},ml={class:"flex items-center space-x-2 mt-1"},gl=["src","onClick"],vl=["onClick"],fl={key:1,class:"italic text-sm text-gray-600 dark:text-gray-400"},pl=["innerHTML"],bl={key:0,class:"mt-3"},hl={key:1,class:"mt-3"},yl=["src","onClick"],kl={class:"flex justify-end space-x-2 mt-2"},xl=["onClick"],_l=["onClick"],wl={key:0},Cl=["src"],$l={__name:"ChildComment",props:{childComments:Array,postId:Number,formatDate:Function,isCommentAuthor:Function,onDeleteItem:Function,toggleCommentForm:Function,commentFormVisibility:Object,openUserProfile:Function,selectedForumId:Number},setup(e){const r=v(!1),l=v(null),m=n=>{l.value=n,r.value=!0};return(n,d)=>{const c=We("ChildComment",!0);return s(),a(z,null,[e.childComments.length?(s(),a("div",dl,[(s(!0),a(z,null,te(e.childComments,i=>{var g,h,o,k;return s(),a("div",{key:i.id,class:"mb-4"},[t("div",ul,[t("p",cl,$(e.formatDate(i.created_at)),1),t("div",ml,[t("img",{src:((g=i.user)==null?void 0:g.iconUrl)||"/images/default_user_icon.png",alt:"User Icon",class:"w-8 h-8 rounded-full cursor-pointer hover:scale-110 transition-transform duration-300",onClick:_=>e.openUserProfile(i),onError:d[0]||(d[0]=_=>_.target.src="/images/default_user_icon.png")},null,40,gl),i.user?(s(),a("span",{key:0,onClick:_=>e.openUserProfile(i),class:"hover:bg-blue-100 dark:hover:bg-blue-900 p-1 rounded cursor-pointer font-semibold text-sm text-gray-800 dark:text-gray-200"}," ＠"+$(i.user.name),9,vl)):(s(),a("span",fl,"＠Unknown"))]),t("p",{class:"mt-2 mb-2 whitespace-pre-wrap text-gray-900 dark:text-gray-100",innerHTML:i.formatted_message},null,8,pl),i.attachments&&i.attachments.length>0?(s(),a("div",bl,[F(oe,{attachments:i.attachments,"show-title":!1,"can-delete":!1},null,8,["attachments"])])):i.img?(s(),a("div",hl,[t("img",{src:`/storage/${i.img}`,alt:"添付画像",class:"w-32 h-32 object-cover rounded-md cursor-pointer hover:opacity-80 transition",onClick:_=>m(`/storage/${i.img}`)},null,8,yl)])):y("",!0),t("div",kl,[t("button",{onClick:_=>{var x;return e.toggleCommentForm(e.postId,i.id,((x=i.user)==null?void 0:x.name)||"Unknown")},class:"px-4 py-2 rounded-md bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-100 transition hover:bg-green-300 dark:hover:bg-green-600 hover:text-white cursor-pointer flex items-center",title:"返信"},d[2]||(d[2]=[t("i",{class:"bi bi-reply"},null,-1)]),8,xl),e.isCommentAuthor(i)?(s(),a("button",{key:0,onClick:_=>e.onDeleteItem("comment",i.id),class:"px-4 py-2 rounded-md bg-red-100 dark:bg-red-800 text-red-700 dark:text-red-300 transition hover:bg-red-300 dark:hover:bg-red-600 hover:text-white cursor-pointer flex items-center",title:"返信の削除"},d[3]||(d[3]=[t("i",{class:"bi bi-trash"},null,-1)]),8,_l)):y("",!0)]),(o=(h=e.commentFormVisibility[e.postId])==null?void 0:h[i.id])!=null&&o.isVisible?(s(),j(ve,{key:2,postId:e.postId,parentId:i.id,"selected-forum-id":e.selectedForumId,replyToName:((k=i.user)==null?void 0:k.name)||"",onCancel:_=>e.toggleCommentForm(e.postId,i.id),class:"mt-4"},null,8,["postId","parentId","selected-forum-id","replyToName","onCancel"])):y("",!0)]),i.children&&i.children.length?(s(),a("div",wl,[F(c,{"child-comments":i.children,postId:e.postId,formatDate:e.formatDate,isCommentAuthor:e.isCommentAuthor,onDeleteItem:e.onDeleteItem,toggleCommentForm:e.toggleCommentForm,commentFormVisibility:e.commentFormVisibility,openUserProfile:e.openUserProfile,selectedForumId:e.selectedForumId},null,8,["child-comments","postId","formatDate","isCommentAuthor","onDeleteItem","toggleCommentForm","commentFormVisibility","openUserProfile","selectedForumId"])])):y("",!0)])}),128))])):y("",!0),F(se,{isOpen:r.value,onClose:d[1]||(d[1]=i=>r.value=!1)},{default:ee(()=>[t("img",{src:l.value,alt:"投稿画像",class:"max-w-full max-h-full rounded-lg"},null,8,Cl)]),_:1},8,["isOpen"])],64)}}};function Il(e=1024){const r=v(!1);if(typeof window<"u"&&window.matchMedia){const l=window.matchMedia(`(max-width: ${e}px)`);r.value=l.matches,l.addEventListener("change",m=>{r.value=m.matches})}return{isMobile:r}}const Fl={key:0,class:"bi bi-heart-fill"},Dl={key:1,class:"bi bi-heart"},Ul={key:1,class:"absolute bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg p-2 max-h-40 overflow-y-auto z-50 mt-2 w-48 transition-opacity duration-200"},Tl={class:"text-sm text-gray-700 dark:text-gray-300"},Sl={class:"py-1 px-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors duration-200"},Ml=500,Pe={__name:"LikeButton",props:{likeableId:{type:Number,required:!0},likeableType:{type:String,required:!0},initialLikeCount:{type:Number,default:0},initialIsLiked:{type:Boolean,default:!1}},setup(e){const r=e,l=v(r.initialIsLiked),m=v(r.initialLikeCount),n=v([]),d=v(null),{isMobile:c}=Il(),i=()=>{d.value&&(clearTimeout(d.value),d.value=null),n.value=[]},g=async()=>{l.value=!l.value,m.value+=l.value?1:-1;try{await $e.post("/like/toggle",{likeable_id:r.likeableId,likeable_type:r.likeableType})}catch(o){l.value=!l.value,m.value+=l.value?1:-1,console.error("いいねのトグルに失敗しました:",o)}},h=async()=>{const o=async()=>{try{const k=await $e.get(`/api/${r.likeableType.toLowerCase()}s/${r.likeableId}/liked-users`);n.value=k.data,console.log(n.value)}catch(k){console.error("いいねしたユーザーの取得に失敗しました:",k)}};c.value?await o():d.value=setTimeout(o,Ml)};return(o,k)=>(s(),a("div",{class:"relative",onMouseout:i,style:{"touch-action":"none"}},[t("button",{onClick:g,onMouseover:k[0]||(k[0]=_=>I(c)?null:h()),class:J([{"text-red-500 dark:text-red-400":l.value,"text-gray-600 dark:text-gray-300":!l.value},"transition-colors duration-200 hover:text-red-500 dark:hover:text-red-400"])},[l.value?(s(),a("i",Fl)):(s(),a("i",Dl)),Y(" "+$(m.value),1)],34),I(c)?(s(),a("button",{key:0,onClick:h,class:"ml-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors duration-200"}," ... ")):y("",!0),n.value.length?(s(),a("div",Ul,[t("ul",Tl,[t("li",Sl,$(n.value.join(", "))+" がいいねしました！ ",1)])])):y("",!0)],32))}},El={key:0},Ll={class:"text-xs text-gray-500 dark:text-gray-400"},Nl={class:"flex items-center space-x-2 mt-1"},Pl=["src","onClick"],Vl=["onClick"],Al={key:1,class:"italic text-sm text-gray-600 dark:text-gray-400"},Ol=["innerHTML"],ql={key:0,class:"mt-3"},jl={key:1,class:"mt-3"},zl=["src","onClick"],Bl={key:2,class:"mt-4"},Rl=["onClick"],Kl={class:"flex justify-end space-x-2 mt-2"},Hl=["onClick"],Wl=["onClick"],Yl={key:4,class:"mt-4 ml-4 border-l-2 border-gray-300 dark:border-gray-600 pl-2"},Jl=["src"],Ql={__name:"ParentComment",props:{comments:Array,postId:Number,formatDate:Function,isCommentAuthor:Function,onDeleteItem:Function,toggleCommentForm:Function,commentFormVisibility:Object,openUserProfile:Function,selectedForumId:Number},setup(e){const r=e,l=v({}),m=v(!1),n=v(null),d=g=>{n.value=g,m.value=!0};re(()=>{r.comments.forEach(g=>{if(g.children&&g.children.length>0){const o=new Date(g.created_at);new Date-o>6048e5?l.value[g.id]=!1:l.value[g.id]=!0}})});const c=g=>{g in l.value?l.value[g]=!l.value[g]:l.value[g]=!0},i=g=>{let h=g.length;return g.forEach(o=>{o.children&&o.children.length>0&&(h+=i(o.children))}),h};return(g,h)=>(s(),a(z,null,[e.comments.length?(s(),a("div",El,[(s(!0),a(z,null,te(e.comments,o=>{var k,_,x,S;return s(),a("div",{key:o.id,class:"mb-6 bg-white dark:bg-gray-800 rounded-md shadow-md p-4"},[t("div",null,[t("p",Ll,$(e.formatDate(o.created_at)),1),t("div",Nl,[t("img",{src:((k=o.user)==null?void 0:k.iconUrl)||"/images/default_user_icon.png",alt:"User Icon",class:"w-8 h-8 rounded-full cursor-pointer hover:scale-110 transition-transform duration-300",onClick:C=>e.openUserProfile(o),onError:h[0]||(h[0]=C=>C.target.src="/images/default_user_icon.png")},null,40,Pl),o.user?(s(),a("span",{key:0,onClick:C=>e.openUserProfile(o),class:"hover:bg-blue-100 dark:hover:bg-blue-900 p-1 rounded cursor-pointer font-semibold text-sm text-gray-800 dark:text-gray-200"}," ＠"+$(o.user.name),9,Vl)):(s(),a("span",Al,"＠Unknown"))]),t("p",{class:"mt-3 mb-2 whitespace-pre-wrap text-gray-900 dark:text-gray-100",innerHTML:o.formatted_message},null,8,Ol),o.attachments&&o.attachments.length>0?(s(),a("div",ql,[F(oe,{attachments:o.attachments,"show-title":!1,"can-delete":!1},null,8,["attachments"])])):o.img?(s(),a("div",jl,[t("img",{src:`/storage/${o.img}`,alt:"添付画像",class:"w-32 h-32 object-cover rounded-md cursor-pointer hover:opacity-80 transition",onClick:C=>d(`/storage/${o.img}`)},null,8,zl)])):y("",!0),o.children&&o.children.length>0?(s(),a("div",Bl,[t("button",{onClick:C=>c(o.id),class:"text-blue-500 dark:text-blue-400 text-lg flex items-center link-hover"},[t("i",{class:J(l.value[o.id]?"bi bi-caret-up-fill":"bi bi-caret-down-fill")},null,2),Y(" "+$(i(o.children))+"件の返信 ",1)],8,Rl)])):y("",!0),t("div",Kl,[F(Pe,{"likeable-id":o.id,"likeable-type":"Comment","initial-like-count":o.like_count,"initial-is-liked":o.is_liked_by_user},null,8,["likeable-id","initial-like-count","initial-is-liked"]),t("button",{onClick:C=>{var L;return e.toggleCommentForm(e.postId,o.id,((L=o.user)==null?void 0:L.name)||"Unknown")},class:"px-4 py-2 rounded-md bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-100 transition hover:bg-green-300 dark:hover:bg-green-600 hover:text-white cursor-pointer flex items-center",title:"返信"},h[2]||(h[2]=[t("i",{class:"bi bi-reply"},null,-1)]),8,Hl),e.isCommentAuthor(o)?(s(),a("button",{key:0,onClick:C=>e.onDeleteItem("comment",o.id),class:"px-4 py-2 rounded-md bg-red-100 dark:bg-red-800 text-red-700 dark:text-red-300 transition hover:bg-red-300 dark:hover:bg-red-600 hover:text-white cursor-pointer flex items-center",title:"返信の削除"},h[3]||(h[3]=[t("i",{class:"bi bi-trash"},null,-1)]),8,Wl)):y("",!0)]),(x=(_=e.commentFormVisibility[e.postId])==null?void 0:_[o.id])!=null&&x.isVisible?(s(),j(ve,{key:3,postId:e.postId,parentId:o.id,"selected-forum-id":e.selectedForumId,replyToName:((S=o.user)==null?void 0:S.name)||"",onCancel:C=>e.toggleCommentForm(e.postId,o.id),class:"mt-4"},null,8,["postId","parentId","selected-forum-id","replyToName","onCancel"])):y("",!0),o.children&&o.children.length>0&&(!(o.id in l.value)||l.value[o.id])?(s(),a("div",Yl,[F($l,{"child-comments":o.children,postId:e.postId,formatDate:e.formatDate,isCommentAuthor:e.isCommentAuthor,onDeleteItem:e.onDeleteItem,toggleCommentForm:e.toggleCommentForm,commentFormVisibility:e.commentFormVisibility,openUserProfile:e.openUserProfile,selectedForumId:e.selectedForumId},null,8,["child-comments","postId","formatDate","isCommentAuthor","onDeleteItem","toggleCommentForm","commentFormVisibility","openUserProfile","selectedForumId"])])):y("",!0)])])}),128))])):y("",!0),F(se,{isOpen:m.value,onClose:h[1]||(h[1]=o=>m.value=!1)},{default:ee(()=>[t("img",{src:n.value,alt:"投稿画像",class:"max-w-full max-h-full rounded-lg"},null,8,Jl)]),_:1},8,["isOpen"])],64))}},Gl={key:0},Zl={class:"flex flex-wrap -mb-1 justify-center"},Xl=["innerHTML"],Ie={__name:"Pagination",props:{links:Array},setup(e){return(r,l)=>e.links.length>3?(s(),a("div",Gl,[t("div",Zl,[(s(!0),a(z,null,te(e.links,(m,n)=>(s(),a(z,{key:n},[m.url===null?(s(),a("div",{key:0,class:"mr-1 mb-1 px-4 py-3 text-sm leading-4 text-gray-400 dark:text-gray-500 border border-gray-300 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-800",innerHTML:m.label},null,8,Xl)):(s(),j(I(Ye),{key:1,class:J(["mr-1 mb-1 px-4 py-3 text-sm leading-4 border border-gray-300 dark:border-gray-600 rounded hover:bg-white dark:hover:bg-gray-700 focus:border-indigo-500 dark:focus:border-indigo-400 focus:text-indigo-500 dark:focus:text-indigo-400 text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-800",{"bg-white dark:bg-gray-700 text-indigo-600 dark:text-indigo-400":m.active}]),href:m.url,innerHTML:m.label},null,8,["class","href","innerHTML"]))],64))),128))])])):y("",!0)}},er={class:"relative flex items-center"},tr={__name:"SearchForm",setup(e){const r=ue().props,l=v(r.search||""),m=v(r.selectedunit_id||null),n=v(r.selectedForumId||null),d=v(!1),c=()=>{d.value||P.get(route("forum.index"),{search:l.value,forum_id:n.value},{preserveScroll:!0,replace:!0})},i=()=>{l.value="",P.get(route("forum.index"),{selectedunit_id:m.value,forum_id:n.value},{replace:!0})},g=()=>{d.value=!0},h=()=>{d.value=!1};return(o,k)=>(s(),a("div",er,[k[2]||(k[2]=t("div",{class:"absolute left-3 text-gray-400 dark:text-gray-500"},[t("i",{class:"bi bi-search"})],-1)),ae(t("input",{"onUpdate:modelValue":k[0]||(k[0]=_=>l.value=_),type:"text",placeholder:"投稿を検索",class:"w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm pl-10 pr-10 focus:border-blue-500 dark:focus:border-blue-400 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400",onKeydown:Je(c,["enter"]),onCompositionstart:g,onCompositionend:h},null,544),[[de,l.value]]),l.value?(s(),a("div",{key:0,class:"absolute right-3 cursor-pointer text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300",onClick:i},k[1]||(k[1]=[t("i",{class:"bi bi-x-lg"},null,-1)]))):y("",!0)]))}},lr={key:0,class:"fixed inset-0 flex items-center justify-center bg-black/50 dark:bg-black/70 z-50"},rr={class:"bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md max-w-md w-full"},sr={class:"border border-gray-300 dark:border-gray-600 p-2 rounded-lg mb-4 bg-gray-100 dark:bg-gray-700"},or={class:"text-gray-600 dark:text-gray-400 whitespace-pre-wrap"},ar={class:"relative mb-4"},ir={key:0,class:"absolute inset-0 z-10 flex items-center justify-center pointer-events-none"},nr={key:0,class:"text-red-500 dark:text-red-400 mt-2"},dr={class:"mt-2"},Fe=100,ur={__name:"QuotePostForm",props:{show:Boolean,quotedPost:Object,forumId:Number},emits:["close"],setup(e,{emit:r}){const l=e,m=r,n=v(""),d=v(""),c=v(null),i=v([]),g=v(null),h=v(!1);v(null);let o=0,k;const _=u=>{var D;const f=(D=u==null?void 0:u.dataTransfer)==null?void 0:D.types;return f&&f.includes&&f.includes("Files")},x=u=>{_(u)&&(u.preventDefault(),o++,h.value=!0)},S=u=>{_(u)&&(u.preventDefault(),h.value=!0)},C=u=>{_(u)&&(u.preventDefault(),o=Math.max(0,o-1),o===0&&(h.value=!1))},L=u=>{var D;if(!_(u))return;u.preventDefault(),o=0,h.value=!1;const f=((D=u.dataTransfer)==null?void 0:D.files)||[];c.value&&f.length>0&&c.value.processExternalFiles(f)},O=()=>{o=0,h.value=!1};re(()=>{k=u=>{_(u)&&u.preventDefault()},window.addEventListener("dragover",k),window.addEventListener("drop",k)}),Se(()=>{k&&(window.removeEventListener("dragover",k),window.removeEventListener("drop",k))});function Q(){const u=document.querySelector('meta[name="csrf-token"]').getAttribute("content");return u||console.error("CSRFトークンが見つかりません。"),u}const B=u=>{i.value=u},q=u=>{g.value=u},G=()=>{m("close")},V=()=>{if(!l.forumId||l.forumId===0){console.error("有効な掲示板IDが選択されていません。");return}const u=new FormData;u.append("title",d.value||""),u.append("message",n.value),u.append("forum_id",l.forumId),u.append("quoted_post_id",l.quotedPost.id),u.append("_token",Q()),i.value.length>0&&i.value.forEach((f,D)=>{u.append(`files[${D}]`,f)}),P.post(route("forum.store"),u,{onSuccess:()=>{d.value="",n.value="",c.value&&c.value.reset(),i.value=[],P.get(route("forum.index",{forum_id:l.forumId}),{preserveState:!0}),m("close")},onError:f=>{console.error("投稿に失敗しました:",f)}})},R=Te(()=>{var u;return((u=l.quotedPost)==null?void 0:u.message.length)>Fe?l.quotedPost.message.slice(0,Fe)+"...":l.quotedPost.message});return(u,f)=>e.show?(s(),a("div",lr,[t("div",rr,[t("div",sr,[f[2]||(f[2]=t("h3",{class:"text-sm font-semibold text-gray-700 dark:text-gray-300"}," 引用元の投稿 ",-1)),t("p",or,$(R.value),1)]),t("div",ar,[F(ge,{modelValue:n.value,"onUpdate:modelValue":f[0]||(f[0]=D=>n.value=D),rows:4,placeholder:"投稿文を入力してください","drag-active":h.value,onAttachClick:f[1]||(f[1]=D=>{var M;return(M=c.value)==null?void 0:M.openFileDialog()}),onDragenter:x,onDragover:S,onDragleave:C,onDrop:L,onMouseleave:O},null,8,["modelValue","drag-active"]),h.value?(s(),a("div",ir,f[3]||(f[3]=[t("div",{class:"w-full h-full border-2 border-dashed border-blue-400 bg-blue-50/70 dark:bg-blue-900/30 rounded-md flex items-center justify-center"},[t("div",{class:"text-center text-blue-700 dark:text-blue-200"},[t("i",{class:"bi bi-paperclip text-3xl mb-2 block"}),t("p",null,"ここにファイルをドロップして添付")])],-1)]))):y("",!0)]),g.value?(s(),a("div",nr,$(g.value),1)):y("",!0),t("div",dr,[F(me,{ref_key:"fileUploadRef",ref:c,showDropZone:!1,onFilesChanged:B,onError:q},null,512)]),t("div",{class:"flex justify-end space-x-2"},[t("button",{onClick:G,class:"my-2 py-2 px-4 rounded-md bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium transition hover:bg-gray-500 dark:hover:bg-gray-500 hover:text-white focus:outline-none focus:shadow-outline"},f[4]||(f[4]=[t("i",{class:"bi bi-x-lg"},null,-1)])),t("button",{onClick:V,class:"my-2 px-4 py-2 rounded-md bg-blue-100 dark:bg-blue-800 text-blue-700 dark:text-blue-300 transition hover:bg-blue-300 dark:hover:bg-blue-600 hover:text-white cursor-pointer"},f[5]||(f[5]=[t("i",{class:"bi bi-send"},null,-1)]))])])])):y("",!0)}},De=e=>st(e).format("YYYY-MM-DD HH:mm:ss"),Ve=(e,r)=>{for(let l=0;l<e.length;l++){if(e[l].id===r)return e[l];if(e[l].children&&e[l].children.length>0){const m=Ve(e[l].children,r);if(m)return m}}return null},Ae=(e,r)=>{for(let l=0;l<e.length;l++){if(e[l].id===r)return e.splice(l,1),!0;if(e[l].children&&e[l].children.length>0&&Ae(e[l].children,r))return!0}return!1},Ue={SELECTED_UNIT_USERS:"selectedUnitUsers",SELECTED_UNIT_NAME:"selectedUnitName"},cr=(e,r)=>{const l=sessionStorage.getItem(Ue.SELECTED_UNIT_USERS);if(l&&l!=="undefined")try{e.value=JSON.parse(l)}catch(n){console.error("Error parsing selectedUnitUsers:",n),e.value=[]}else e.value=[];const m=sessionStorage.getItem(Ue.SELECTED_UNIT_NAME);r.value=m||""},mr=e=>{const r=ue().props;if(!e){console.warn("selectedForumId が無効です");return}e.value=(r==null?void 0:r.selectedForumId)||null},gr=(e,r)=>{r&&e.get(route("forum.index",{forum_id:r}),{preserveState:!0,only:["posts"]})},vr={class:"flex mt-16 gap-4"},fr={class:"flex-1 p-4 forum-main-content"},pr={class:"flex items-center mb-4 relative"},br={class:"absolute top-full right-36 text-sm text-gray-600 dark:text-gray-400 mt-1 mb-16"},hr={key:0},yr={class:"mt-12 h-12 flex items-center justify-center"},kr={class:"mb-4"},xr={key:0,class:"text-gray-500 dark:text-gray-400 italic mb-2 p-2 border-l-4 border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700"},_r={key:1,class:"quoted-post p-2 border-l-4 border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700"},wr={class:"flex items-center space-x-2"},Cr=["src","onClick"],$r=["onClick"],Ir={class:"text-sm mb-2 font-bold text-gray-900 dark:text-gray-100"},Fr={class:"text-sm mb-2 whitespace-pre-wrap text-gray-700 dark:text-gray-300"},Dr={key:0,class:"mt-2"},Ur={key:1,class:"mt-2"},Tr=["src","onClick"],Sr={class:"mb-2 text-xs text-gray-500 dark:text-gray-400"},Mr={key:0,class:"flex items-center space-x-2"},Er=["src","onClick"],Lr=["onClick"],Nr={key:1},Pr={class:"mb-2 text-xl font-bold text-gray-900 dark:text-gray-100"},Vr=["innerHTML"],Ar={key:0,class:"mt-3"},Or={key:1,class:"mt-3"},qr=["src","onClick"],jr={class:"flex justify-end space-x-2 mt-2"},zr=["onClick"],Br=["onClick"],Rr=["onClick"],Kr={class:"font-bold mt-8 mb-2 text-gray-900 dark:text-gray-100"},Hr={key:2,class:"text-center text-gray-500 dark:text-gray-400 text-lg font-semibold mt-6"},Wr=["src"],Yr={__name:"Forum",setup(e){const{posts:r={data:[],links:[]},auth:l,units:m=[],users:n=[],selectedForumId:d=null,search:c="",userUnitId:i=null}=ue().props,g=v(r),h=v(m),o=v(null),k=v(!1),_=v(!1),x=v(n),S=v(null),C=v(d),L=v([]),O=v(""),Q=v(c),B=v(null),q=v(!1),V=v((()=>{const w=new URLSearchParams(window.location.search).get("active_unit_id");if(w)return parseInt(w);if(d&&m.length>0){const A=m.find(K=>K.forum&&K.forum.id===d);if(A)return A.id}if(i)return i;if(l.user.unit_id)return l.user.unit_id;const T=localStorage.getItem("lastSelectedUnitId");return T?parseInt(T):null})()),R=v(!1),u=v(null),f=p=>{B.value=p,q.value=!0};re(()=>{mr(C),cr(L,O),V.value&&localStorage.setItem("lastSelectedUnitId",V.value.toString())}),ne(C,p=>{gr(P,p)}),ne(_,p=>{p?document.body.classList.add("no-scroll"):document.body.classList.remove("no-scroll")});const D=p=>{o.value={user:p},k.value=!0},M=async p=>{const w=h.value.find(A=>A.id===p);if(!w||!w.forum){console.error("対応する掲示板が見つかりませんでした");return}const T=Array.isArray(x.value)?x.value.filter(A=>A.unit_id===p):[];C.value=w.forum.id,O.value=w.name,L.value=T,sessionStorage.setItem("selectedUnitName",O.value),sessionStorage.setItem("selectedUnitUsers",JSON.stringify(T)),localStorage.setItem("lastSelectedUnitId",p),P.get(route("forum.index",{forum_id:C.value,active_unit_id:p}),{preserveState:!1}),document.body.classList.remove("no-scroll")},U=p=>{P.get(p,{preserveScroll:!0,preserveState:!0,only:["posts"]})},E=p=>{o.value=p,k.value=!0},Z=()=>{k.value=!1},fe=()=>{_.value=!_.value},N=v({}),ie=(p,w="post",T="")=>{N.value[p]||(N.value[p]={}),N.value[p][w]||(N.value[p][w]={isVisible:!1,replyToName:""}),N.value[p][w].isVisible=!N.value[p][w].isVisible,N.value[p][w].replyToName=T,N.value={...N.value}},le=Ge(),pe=async(p,w)=>{const T=p==="post"?"この投稿を削除してもよろしいですか？":p==="comment"?"この返信を削除してもよろしいですか？":"この投稿を削除してもよろしいですか？";await le.showDialog(T)&&et(p,w,async K=>{if(p==="post"){g.value.data=g.value.data.map(H=>H.quoted_post&&H.quoted_post.id===K?{...H,quoted_post_deleted:1,quoted_post:null}:H).filter(H=>H.id!==K);const b=route("forum.index",{forum_id:C.value});window.history.replaceState({},"",b),P.reload({only:["posts"],preserveState:!0,preserveScroll:!0,replace:!0})}else p==="comment"&&Oe(K)})},Oe=p=>{const w=g.value.data.findIndex(T=>Ve(T.comments,p));if(w!==-1){const T=g.value.data[w].comments;Ae(T,p)?g.value.data[w].comments=[...T]:console.error(`返信削除に失敗しました: ${p}`)}else console.error(`削除対象の返信が見つかりませんでした: ${p}`)},be=p=>{let w=p.length;return p.forEach(T=>{T.children&&T.children.length>0&&(w+=be(T.children))}),w},qe=p=>be(p.comments),je=p=>l.user&&p.user&&l.user.id===p.user.id,ze=p=>{V.value=p,localStorage.setItem("lastSelectedUnitId",p),M(p)},he=p=>{u.value=p,R.value=!0};return(p,w)=>(s(),a(z,null,[F(I(Qe),{title:p.$t("Forum")},null,8,["title"]),F(Ze,null,{default:ee(()=>{var T,A,K;return[F(Xe,{"is-visible":I(le).state.isVisible,message:I(le).state.message,onConfirm:I(le).confirm,onCancel:I(le).cancel},null,8,["is-visible","message","onConfirm","onCancel"]),t("div",vr,[_.value?(s(),a("div",{key:0,class:"overlay",onClick:fe})):y("",!0),F(lt,{units:h.value,users:x.value,"active-unit-id":V.value,class:J(["sidebar-mobile p-4 sm:mt-16 lg:block",{visible:_.value}]),ref_key:"sidebar",ref:S,onUserProfileClicked:D,sidebarVisible:_.value,"onUpdate:sidebarVisible":w[0]||(w[0]=b=>_.value=b),onForumSelected:ze},null,8,["units","users","active-unit-id","class","sidebarVisible"]),t("div",fr,[t("div",pr,[t("h1",{class:"text-lg font-bold cursor-pointer text-gray-500 dark:text-gray-300 hover:text-black dark:hover:text-white p-2 toggle-button",onClick:fe},$(p.$t("Unit List")),1),F(tr,{"selected-forum-id":C.value,class:"ml-auto"},null,8,["selected-forum-id"]),t("div",br,[Q.value?(s(),a("p",hr,"検索結果: "+$(g.value.total)+"件",1)):y("",!0)])]),t("div",yr,[(A=(T=g.value)==null?void 0:T.links)!=null&&A.length?(s(),j(Ie,{key:0,links:g.value.links,onChange:U},null,8,["links"])):y("",!0)]),C.value?(s(),j(Lt,{key:0,"forum-id":Number(C.value),class:"mb-6",title:"投稿"},null,8,["forum-id"])):y("",!0),g.value.data&&g.value.data.length>0?(s(!0),a(z,{key:1},te(g.value.data,b=>{var H,ye,ke,xe,_e,we,Ce;return s(),a("div",{key:b.id,class:"bg-white dark:bg-gray-800 rounded-md shadow-md mb-6 p-4"},[t("div",null,[t("div",kr,[b.quoted_post_deleted===1?(s(),a("p",xr," 引用元の投稿は削除されました ")):b.quoted_post?(s(),a("div",_r,[t("div",wr,[t("img",{src:((H=b.quoted_post.user)==null?void 0:H.iconUrl)||"/images/default_user_icon.png",alt:"User Icon",class:"w-8 h-8 rounded-full cursor-pointer hover:scale-110 transition-transform duration-300 mb-1",onClick:W=>E(b.quoted_post)},null,8,Cr),t("span",{onClick:W=>E(b.quoted_post),class:"hover:bg-blue-100 dark:hover:bg-blue-900 p-1 rounded cursor-pointer text-sm text-gray-800 dark:text-gray-200"}," ＠"+$(((ye=b.quoted_post.user)==null?void 0:ye.name)||"Unknown"),9,$r)]),t("p",Ir,$(b.quoted_post.title),1),t("p",Fr,$(b.quoted_post.message),1),b.quoted_post.attachments&&b.quoted_post.attachments.length>0?(s(),a("div",Dr,[F(oe,{attachments:b.quoted_post.attachments,"show-title":!1,"can-delete":!1},null,8,["attachments"])])):b.quoted_post.img?(s(),a("div",Ur,[t("img",{src:`/storage/${b.quoted_post.img}`,alt:"引用投稿画像",class:"w-24 h-24 object-cover rounded-md cursor-pointer hover:opacity-80 transition",onClick:W=>he(`/storage/${b.quoted_post.img}`)},null,8,Tr)])):y("",!0)])):y("",!0)]),t("p",Sr,[Y($(I(De)(b.created_at))+" ",1),b.user?(s(),a("span",Mr,[t("img",{src:((ke=b.user)==null?void 0:ke.iconUrl)||"/images/default_user_icon.png",alt:"User Icon",class:"w-12 h-12 rounded-full cursor-pointer hover:scale-110 transition-transform duration-300 mb-1",onClick:W=>E(b)},null,8,Er),t("span",{onClick:W=>E(b),class:"text-sm font-semibold text-gray-800 dark:text-gray-200 hover:bg-blue-100 dark:hover:bg-blue-900 p-1 rounded cursor-pointer"}," ＠"+$(b.user.name),9,Lr)])):(s(),a("span",Nr,"＠Unknown"))]),t("p",Pr,$(b.title),1),t("p",{class:"mb-2 whitespace-pre-wrap text-gray-900 dark:text-gray-100",innerHTML:b.formatted_message},null,8,Vr),b.attachments&&b.attachments.length>0?(s(),a("div",Ar,[F(oe,{attachments:b.attachments,"show-title":!0,"can-delete":!1},null,8,["attachments"])])):b.img?(s(),a("div",Or,[t("img",{src:`/storage/${b.img}`,alt:"投稿画像",class:"w-48 h-48 object-cover rounded-md cursor-pointer hover:opacity-80 transition-opacity duration-300",onClick:W=>he(`/storage/${b.img}`)},null,8,qr)])):y("",!0),t("div",jr,[F(Pe,{"likeable-id":b.id,"likeable-type":"Post","initial-like-count":b.like_count,"initial-is-liked":b.is_liked_by_user},null,8,["likeable-id","initial-like-count","initial-is-liked"]),t("button",{onClick:W=>ie(b.id,"post",b.user?b.user.name:"Unknown"),class:"px-4 py-2 rounded-md bg-green-100 dark:bg-green-800 text-green-700 dark:text-green-300 transition hover:bg-green-300 dark:hover:bg-green-600 hover:text-white cursor-pointer",title:"返信"},w[4]||(w[4]=[t("i",{class:"bi bi-reply"},null,-1)]),8,zr),t("button",{type:"button",onClick:W=>f(b),class:"px-4 py-2 rounded-md bg-blue-100 dark:bg-blue-800 text-blue-700 dark:text-blue-300 transition hover:bg-blue-300 dark:hover:bg-blue-600 hover:text-white cursor-pointer flex items-center",title:"引用投稿"},w[5]||(w[5]=[t("i",{class:"bi bi-chat-quote"},null,-1)]),8,Br),b.user&&b.user.id===I(l).user.id?(s(),a("button",{key:0,onClick:X(W=>pe("post",b.id),["prevent"]),class:"px-4 py-2 ml-2 rounded-md bg-red-100 dark:bg-red-800 text-red-700 dark:text-red-300 transition hover:bg-red-300 dark:hover:bg-red-600 hover:text-white cursor-pointer",title:"投稿の削除"},w[6]||(w[6]=[t("i",{class:"bi bi-trash"},null,-1)]),8,Rr)):y("",!0)]),(_e=(xe=N.value[b.id])==null?void 0:xe.post)!=null&&_e.isVisible?(s(),j(ve,{key:2,postId:b.id,parentId:null,"selected-forum-id":Number(C.value),replyToName:(Ce=(we=N.value[b.id])==null?void 0:we.post)==null?void 0:Ce.replyToName,onCancel:W=>ie(b.id,"post"),class:"mt-4 comment-form",title:"返信"},null,8,["postId","selected-forum-id","replyToName","onCancel"])):y("",!0)]),t("h3",Kr,$(qe(b))+"件の返信 ",1),F(Ql,{comments:b.comments,postId:b.id,formatDate:I(De),isCommentAuthor:je,onDeleteItem:pe,toggleCommentForm:ie,commentFormVisibility:N.value,openUserProfile:E,selectedForumId:Number(C.value)},null,8,["comments","postId","formatDate","commentFormVisibility","selectedForumId"])])}),128)):(s(),a("div",Hr," 投稿がありません。 ")),F(se,{isOpen:R.value,onClose:w[1]||(w[1]=b=>R.value=!1)},{default:ee(()=>[t("img",{src:u.value,alt:"投稿画像",class:"max-w-full max-h-full rounded-lg"},null,8,Wr)]),_:1},8,["isOpen"]),F(Ie,{links:((K=g.value)==null?void 0:K.links)||[],onChange:U,class:"mt-4"},null,8,["links"])]),F(rt,{"unit-users":L.value,"unit-name":O.value,users:x.value,"active-unit-id":V.value,class:"p-4 lg:mt-16 sm:block",onUserSelected:D},null,8,["unit-users","unit-name","users","active-unit-id"]),k.value?(s(),a("div",{key:1,class:"fixed inset-0 bg-black/50 dark:bg-black/70 flex justify-center items-center z-50",onClick:Z},[t("div",{onClick:w[2]||(w[2]=X(()=>{},["stop"]))},[o.value?(s(),j(tt,{key:0,user:o.value.user,units:h.value},null,8,["user","units"])):y("",!0)])])):y("",!0),q.value&&B.value?(s(),j(ur,{key:2,show:q.value,"quoted-post":B.value,"forum-id":Number(C.value),onClose:w[3]||(w[3]=b=>q.value=!1)},null,8,["show","quoted-post","forum-id"])):y("",!0)])]}),_:1})],64))}},as=ce(Yr,[["__scopeId","data-v-d5ab868e"]]);export{as as default};
