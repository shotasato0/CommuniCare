# プルリクエストルール

このドキュメントは、CommuniCareV2プロジェクトにおけるプルリクエスト（PR）の作成・レビュー・マージに関するルールを定義します。

---

## ブランチ命名規則

### ブランチ名の形式

```
{種類}/{番号または簡潔な説明}
```

### 種類

- `feature/`: 新機能追加
- `fix/`: バグ修正
- `update/`: 既存機能の改善・更新
- `refactor/`: リファクタリング
- `docs/`: ドキュメント関連
- `chore/`: ビルド・ツール・設定変更
- `remove/`: 機能・ファイルの削除

### 例

- `feature/#198` - イシュー番号を使用
- `fix/login-error` - 簡潔な説明を使用
- `update/user-management` - 機能名を使用

---

## PR作成前のチェックリスト

### 必須チェック項目

PRを作成する前に、以下のチェックを必ず実行してください：

```bash
# 1. リモートとの差分を取得
git fetch

# 2. mainブランチとの差分コミットを確認
git log origin/main..HEAD --oneline

# 3. 差分ファイル・行数を確認
git diff origin/main..HEAD --stat

# 4. クリティカルな修正を確認
git diff origin/main..HEAD
```

### コード品質チェック

- [ ] Laravel Pintでコードフォーマットが適用されている
- [ ] PHPStanのエラーがない（該当する場合）
- [ ] ESLintのエラーがない（該当する場合）
- [ ] テストが全て通過している
- [ ] 新規機能にはテストが追加されている

### セキュリティチェック

- [ ] マルチテナント境界チェックが実装されている
- [ ] `tenant_id`が適切にフィルタリングされている
- [ ] 権限チェックが実装されている
- [ ] 個人情報保護法に準拠している

### ドキュメントチェック

- [ ] 新規機能にはドキュメントが追加されている（必要に応じて）
- [ ] 既存ドキュメントとの整合性が保たれている
- [ ] コメントが適切に記載されている

---

## PRテンプレート

### PRタイトル

```
{種類}: {簡潔な説明}
```

**種類**:
- `fix`: バグ修正
- `add`: 新規機能追加
- `update`: 機能更新
- `remove`: 削除
- `refactor`: リファクタリング
- `docs`: ドキュメント

**例**: `add: ユーザー管理画面に検索機能を追加`

### PR本文テンプレート

```markdown
### 目的

この変更を行った背景と目標を記載してください。

### 達成条件

完了とみなすための条件・基準を記載してください。

### 実装の概要

主な変更点と実装内容の説明を記載してください。

### 対処したバグ

修正したバグや問題があれば記載してください（該当しない場合は「なし」と記載）。

### 必要なかった実装

採用を検討したが結果的に削除・見送った内容があれば記載してください（該当しない場合は「なし」と記載）。

### レビューしてほしいところ

特に確認してもらいたい箇所や観点を記載してください。

### 不安に思っていること

懸念点や疑問に感じている部分があれば記載してください（該当しない場合は「なし」と記載）。

### 保留していること

今回は対応せず、今後検討する項目があれば記載してください（該当しない場合は「なし」と記載）。
```

### PR作成コマンド（ドラフト）

```bash
gh pr create \
  --draft \
  --title "{PRタイトル}" \
  --body "$(cat << 'EOF'
{PR本文テンプレートの内容}
EOF
)"
```

**注意事項**:
- PRは必ず**ドラフト**として作成する
- 対象ブランチは`main`（デフォルト）
- タイトルは`--title`オプションで指定し、PR本文には含めない
- 事前チェック結果（差分コミット、差分ファイル・行数など）はPR本文には含めない

---

## レビューの観点

### コードレビュー時のチェックポイント

#### セキュリティ

- [ ] マルチテナント境界が適切に実装されている
- [ ] `tenant_id`によるデータ分離が保証されている
- [ ] 権限チェックが適切に実装されている
- [ ] SQLインジェクションやXSSなどの脆弱性がない
- [ ] 個人情報が適切に保護されている

#### アーキテクチャ

- [ ] Service Layerパターンが適切に使用されている
- [ ] コントローラーが薄く保たれている
- [ ] ビジネスロジックがServiceクラスに集約されている
- [ ] 適切な例外処理が実装されている

#### コード品質

- [ ] コードが読みやすく、理解しやすい
- [ ] 命名規則が統一されている
- [ ] 適切なコメントが記載されている
- [ ] 重複コードがない
- [ ] 適切な型ヒントが使用されている

#### テスト

- [ ] テストが適切に追加されている
- [ ] テストが全て通過している
- [ ] エッジケースが考慮されている
- [ ] セキュリティテストが含まれている（該当する場合）

#### パフォーマンス

- [ ] N+1問題がない
- [ ] 適切なインデックスが設定されている
- [ ] 不要なクエリがない
- [ ] キャッシュが適切に使用されている（該当する場合）

---

## マージ条件

### 必須条件

以下の条件を全て満たしている必要があります：

1. **レビュー承認**: 最低1名以上のレビュー承認
2. **CI/CD通過**: 全てのCI/CDチェックが通過している
3. **コンフリクト解消**: マージ先ブランチとのコンフリクトがない
4. **テスト通過**: 全てのテストが通過している
5. **コード品質**: コードフォーマット・リントチェックが通過している

### マージ禁止条件

以下のいずれかに該当する場合は、マージを禁止します：

- セキュリティ上の問題がある
- マルチテナント境界違反の可能性がある
- 破壊的な変更が適切に文書化されていない
- テストが不足している
- レビューコメントが未対応である

---

## コミットメッセージルール

### コミットメッセージ形式

```
{種類}: {要約}

{理由・詳細説明}
```

### 種類

- `fix`: バグ修正
- `add`: 新規機能追加
- `update`: 機能更新
- `remove`: 削除
- `refactor`: リファクタリング
- `docs`: ドキュメント

### 例

```
update: ユーザー管理画面に検索機能を追加

refs #198 ユーザー一覧画面でユーザー名・メールアドレスによる検索ができるようにしました。
検索はリアルタイムで実行され、結果が即座に表示されます。
```

---

## 緊急時の対応

### ホットフィックスの場合

緊急のバグ修正（ホットフィックス）の場合：

1. `fix/hotfix-{説明}`ブランチを作成
2. 最小限の変更で修正
3. 通常のPRプロセスを経由（レビュー必須）
4. マージ後、`main`ブランチから`develop`ブランチにもマージ

### セキュリティ問題の場合

セキュリティ上の問題が発見された場合：

1. 即座にセキュリティチームに報告
2. セキュリティブランチを作成（`security/{説明}`）
3. 修正内容を最小限に抑える
4. 通常のPRプロセスを経由（レビュー必須）
5. マージ後、影響範囲を確認し、必要に応じて通知

---

## よくある質問

### Q: PRのサイズはどのくらいが適切ですか？

A: 1つのPRは、1つの論理的な変更に絞ることを推奨します。300行以下の変更が理想的ですが、機能の性質によってはそれ以上になる場合もあります。大きな変更の場合は、複数のPRに分割することを検討してください。

### Q: ドラフトPRはいつReady for Reviewにしますか？

A: 以下の条件を満たした時点でReady for Reviewにしてください：
- 実装が完了している
- テストが全て通過している
- 自己レビューを完了している
- PR本文が適切に記載されている

### Q: レビューコメントへの対応はどのように行いますか？

A: レビューコメントに対しては、以下のいずれかの方法で対応してください：
- コメントに対して返信し、修正内容を説明する
- 修正をコミットし、コメントに「修正しました」と返信する
- 質問や議論が必要な場合は、コメントで議論を続ける

---

## 関連ドキュメント

- `rules_for_ai.md`: AIエージェントの実行プロセス・Git運用・PR指針
- `.cursor/rules/cursor-rules.md`: プロジェクトの構造・技術スタック・コーディングスタイル

---

## 改訂履歴

- 2026-02-07: 初版作成
